<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Печенька.ru</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        /* Стили для выпадающего списка с описанием */
        .product-option {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
        }
        .product-name {
            font-weight: 600;
            color: #333;
        }
        .product-description {
            font-size: 0.9em;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 400px;
        }
        .product-price {
            font-size: 0.85em;
            color: #28a745;
            font-weight: 500;
        }
        .product-category {
            font-size: 0.85em;
            color: #6c757d;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 5px;
        }
        .select2-container--bootstrap5 .select2-results__option {
            padding: 8px 12px;
        }

        /* Улучшенный блок с информацией о товаре */
        #productDetails {
            transition: all 0.3s ease;
        }
        .product-detail-card {
            border-left: 4px solid #0d6efd;
        }
        .detail-label {
            font-weight: 600;
            color: #495057;
            min-width: 100px;
        }
        .detail-value {
            color: #212529;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark mb-4">
    <div class="container">
        <a class="navbar-brand" href="/admin/stock">
            <i class="bi bi-arrow-left"></i> Назад к списку
        </a>
    </div>
</nav>

<div class="container">
    <div class="form-container">
        <div class="text-center mb-3">
            <h1 class="text-gray-900">
                <i class="bi bi-boxes"></i>
                <span th:if="${stock.id != null}">Редактирование остатка</span>
                <span th:unless="${stock.id != null}">Добавление нового остатка</span>
            </h1>
            <p class="text-gray-500">
                <span th:if="${stock.id != null}">Изменение данных об остатке на складе</span>
                <span th:unless="${stock.id != null}">Добавление товара на склад</span>
            </p>
        </div>

        <!-- Сообщения об ошибках -->
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show mt-3 mb-4">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Сообщения об успехе -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show mt-3 mb-4">
            <i class="bi bi-check-circle me-2"></i>
            <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-box-arrow-in-down"></i> Основная информация
                </h5>
            </div>
            <div class="card-body">
                <form th:action="@{/admin/stock}" method="post" th:object="${stock}">
                    <!-- Скрытое поле для ID -->
                    <input type="hidden" name="id" th:value="${stock.id}" />

                    <!-- Сообщения об ошибках валидации -->
                    <div th:if="${#fields.hasErrors('*')}" class="alert alert-warning alert-dismissible fade show mb-4">
                        <i class="bi bi-exclamation-circle me-2"></i>
                        <strong>Пожалуйста, исправьте следующие ошибки:</strong>
                        <ul class="mb-0 mt-2">
                            <li th:each="err : ${#fields.errors('*')}" th:text="${err}"></li>
                        </ul>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>

                    <!-- Товар -->
                    <div class="mb-3">
                        <label class="form-label required-field">
                            Название товара
                        </label>
                        <select id="productSelect" name="product" class="form-select" th:field="*{product}" required
                                onchange="showProductDetails(this)">
                            <option value="">Выберите товар</option>
                            <option th:each="product : ${products}"
                                    th:value="${product.id}"
                                    th:selected="${stock.product != null and stock.product.id == product.id}"
                                    th:data-description="${product.description}"
                                    th:data-category="${product.category != null ? product.category.name : 'Без категории'}"
                                    th:data-price="${product.price != null ? product.price.setScale(2).toString() : '0.00'}"
                                    th:data-id="${product.id}"
                                    th:title="${product.description}"
                                    th:data-price-raw="${product.price != null ? product.price : 0}">
                                <!-- Отображаем название, категорию и краткое описание -->
                                <span th:text="${product.name}"></span>
                                <small class="text-muted" th:if="${product.category != null}">
                                    (<span th:text="${product.category.name}"></span>)
                                </small>
                                <br>
                                <small class="text-muted" th:if="${product.description != null and product.description.length() > 0}">
                                    <i class="bi bi-card-text"></i>
                                    <span th:text="${#strings.abbreviate(product.description, 60)}"></span>
                                </small>
                                <small class="text-muted" th:unless="${product.description != null and product.description.length() > 0}">
                                    <i class="bi bi-card-text"></i> Описание отсутствует
                                </small>
                                <br>
                                <small class="text-success">
                                    <i class="bi bi-currency-ruble"></i>
                                    <span th:text="${product.price != null ? #numbers.formatDecimal(product.price, 1, 2) : '0.00'}"></span> ₽
                                </small>
                            </option>
                        </select>
                        <div class="text-danger small mt-1" th:if="${#fields.hasErrors('product')}" th:errors="*{product}"></div>

                        <!-- Подсказка -->
                        <div class="form-text text-gray-500">
                            <i class="bi bi-info-circle"></i> Выберите товар для добавления на склад.
                            В списке отображается название, категория, краткое описание и цена.
                        </div>
                    </div>

                    <!-- Детальная информация о выбранном товаре -->
                    <div id="productDetails" class="card product-detail-card mb-4" style="display: none;">
                        <div class="card-body">
                            <h6 class="card-title mb-3">
                                <i class="bi bi-info-square"></i> Информация о выбранном товаре
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <span class="detail-label">Название:</span>
                                        <span class="detail-value" id="detailName"></span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="detail-label">Категория:</span>
                                        <span class="detail-value" id="detailCategory"></span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="detail-label">ID товара:</span>
                                        <span class="detail-value" id="detailId"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <span class="detail-label">Цена:</span>
                                        <span class="detail-value text-success" id="detailPrice"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <span class="detail-label">Описание:</span>
                                <div class="detail-value mt-1 p-2 bg-light rounded" id="detailDescription"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Склад -->
                    <div class="mb-3">
                        <label class="form-label required-field">
                            Склад
                        </label>
                        <select name="warehouse" class="form-select" th:field="*{warehouse}" required>
                            <option value="">Выберите склад</option>
                            <option th:each="warehouse : ${warehouses}"
                                    th:value="${warehouse.id}"
                                    th:selected="${stock.warehouse != null and stock.warehouse.id == warehouse.id}"
                                    th:text="${warehouse.address}">
                            </option>
                        </select>
                        <div class="text-danger small mt-1" th:if="${#fields.hasErrors('warehouse')}" th:errors="*{warehouse}"></div>
                        <div class="form-text text-gray-500">
                            <i class="bi bi-info-circle"></i> Выберите склад, на котором будет храниться товар
                        </div>
                    </div>

                    <!-- Количество -->
                    <div class="mb-4">
                        <label class="form-label required-field">
                            Количество
                        </label>
                        <div class="input-group">
                            <input type="number" name="quantity" class="form-control"
                                   th:field="*{quantity}"
                                   min="0" step="1" required
                                   placeholder="Введите количество">
                            <span class="input-group-text">шт.</span>
                        </div>
                        <div class="text-danger small mt-1" th:if="${#fields.hasErrors('quantity')}" th:errors="*{quantity}"></div>
                        <div class="form-text text-gray-500">
                            <i class="bi bi-info-circle"></i> Укажите количество товара на складе. Только целые числа.
                        </div>
                    </div>

                    <!-- Кнопки формы -->
                    <div class="d-flex justify-content-between">
                        <a href="/admin/stock" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Отмена
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i>
                            <span th:if="${stock.id != null}">Сохранить изменения</span>
                            <span th:unless="${stock.id != null}">Добавить остаток</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </div>
</div>

<footer class="footer">
    <div class="container text-center">
        <p class="mb-0">© 2026 Печенька.ru - Система управления</p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/app.js}"></script>
<script>
    // Валидация формы на клиенте
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        const requiredFields = form.querySelectorAll('[required]');

        form.addEventListener('submit', function(e) {
            let isValid = true;

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });

            if (!isValid) {
                e.preventDefault();
                alert('Пожалуйста, заполните все обязательные поля');
            }
        });

        // Удаление класса is-invalid при вводе
        requiredFields.forEach(field => {
            field.addEventListener('input', function() {
                if (this.value.trim()) {
                    this.classList.remove('is-invalid');
                }
            });
        });

        // Автоматическое скрытие alert через 5 секунд
        setTimeout(function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                if (alert.classList.contains('show')) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            });
        }, 5000);

        // Показываем детали товара при загрузке страницы (если товар уже выбран)
        const productSelect = document.getElementById('productSelect');
        if (productSelect.value) {
            showProductDetails(productSelect);
        }

        // Добавляем обработчик для отображения полного текста описания при наведении на option
        const options = productSelect.options;
        for (let i = 0; i < options.length; i++) {
            const option = options[i];
            if (option.title) {
                option.setAttribute('data-bs-toggle', 'tooltip');
                option.setAttribute('data-bs-placement', 'right');
                option.setAttribute('data-bs-title', option.title);
            }
        }

        // Инициализируем tooltips
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
    });

    // Функция для отображения детальной информации о товаре
    function showProductDetails(selectElement) {
        const detailsDiv = document.getElementById('productDetails');
        const selectedOption = selectElement.options[selectElement.selectedIndex];

        if (selectElement.value && selectedOption) {
            // Получаем полный текст option
            const optionText = selectedOption.textContent || '';
            const lines = optionText.split('\n').filter(line => line.trim() !== '');

            // Извлекаем информацию из строк
            const nameLine = lines[0] || '';
            const descLine = lines[1] || '';
            const priceLine = lines[2] || '';

            // Убираем лишние элементы из названия
            const name = nameLine.replace(/\(.*?\)/g, '').trim();

            // Получаем данные из data-атрибутов
            const description = selectedOption.getAttribute('data-description') || 'Описание отсутствует';
            const category = selectedOption.getAttribute('data-category') || 'Без категории';
            const price = selectedOption.getAttribute('data-price') || '0.00';
            const productId = selectElement.value;

            // Заполняем блок детальной информацией
            document.getElementById('detailName').textContent = name;
            document.getElementById('detailCategory').textContent = category;
            document.getElementById('detailId').textContent = productId;
            document.getElementById('detailPrice').textContent = price + ' ₽';
            document.getElementById('detailDescription').textContent = description;

            // Показываем блок
            detailsDiv.style.display = 'block';

            // Анимация появления
            detailsDiv.style.opacity = '0';
            detailsDiv.style.transform = 'translateY(-10px)';
            setTimeout(() => {
                detailsDiv.style.opacity = '1';
                detailsDiv.style.transform = 'translateY(0)';
            }, 10);
        } else {
            // Скрываем блок, если товар не выбран
            detailsDiv.style.display = 'none';
        }
    }

    // Функция для форматирования цены
    function formatPrice(price) {
        return parseFloat(price).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
    }
</script>
</body>
</html>