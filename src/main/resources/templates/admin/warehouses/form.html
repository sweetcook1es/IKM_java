<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Печенька.ru</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark mb-4">
    <div class="container">
        <a class="navbar-brand" href="/admin/warehouses">
            <i class="bi bi-arrow-left"></i> Назад к списку
        </a>
    </div>
</nav>

<div class="container">
    <div class="form-container">
        <div class="text-center mb-5">
            <h1 class="text-gray-900">
                <i class="bi bi-building"></i>
                <span th:if="${warehouse.id != null}">Редактирование склада</span>
                <span th:unless="${warehouse.id != null}">Добавление нового склада</span>
            </h1>
            <p class="text-gray-500">
                <span th:if="${warehouse.id != null}">Изменение адреса склада</span>
                <span th:unless="${warehouse.id != null}">Добавление нового склада в систему</span>
            </p>
        </div>

        <!-- Flash сообщения -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show mb-4" role="alert">
            <i class="bi bi-check-circle"></i>
            <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <!-- Сообщения об ошибках -->
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
            <i class="bi bi-exclamation-triangle"></i>
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <!-- Внимание, если на складе есть остатки -->
        <div th:if="${warehouse.id != null and warehouse.stock != null and warehouse.stock.size() > 0}"
             class="alert alert-warning alert-dismissible fade show mb-4">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>Внимание!</strong> На этом складе есть товары:
            <span th:text="${warehouse.stock.size()}"></span> позиций.
            Изменение адреса не повлияет на эти остатки.
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle"></i> Информация о складе
                </h5>
            </div>
            <div class="card-body">
                <form th:action="${warehouse.id != null ?
                                 '/admin/warehouses/' + warehouse.id :
                                 '/admin/warehouses'}"
                      method="post" th:object="${warehouse}">

                    <!-- ID склада (только для редактирования) -->
                    <div th:if="${warehouse.id != null}" class="mb-3">
                        <label class="form-label text-gray-500">ID склада</label>
                        <input type="text" class="form-control bg-light"
                               th:value="${warehouse.id}" readonly>
                    </div>

                    <!-- Количество остатков (только для редактирования) -->
                    <div th:if="${warehouse.id != null}" class="mb-3">
                        <label class="form-label text-gray-500">Товаров на складе</label>
                        <input type="text" class="form-control bg-light"
                               th:value="${warehouse.stock != null ? warehouse.stock.size() : 0} + ' позиций'" readonly>
                        <div class="form-text text-gray-500">
                            <a th:href="@{'/admin/stock?warehouse=' + ${warehouse.id}}"
                               class="text-decoration-none">
                                <i class="bi bi-eye"></i> Просмотреть остатки
                            </a>
                        </div>
                    </div>

                    <!-- Адрес склада -->
                    <div class="mb-3">
                        <label for="address" class="form-label required-field">
                            Адрес склада
                            <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="address"
                               th:field="*{address}"
                               th:classappend="${#fields.hasErrors('address')} ? 'is-invalid' : ''"
                               placeholder="Например: ул. Ленина, д. 15"
                               required>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('address')}">
                            <span th:each="err : ${#fields.errors('address')}" th:text="${err}"></span>
                        </div>
                        <div class="form-text text-gray-500">
                            Укажите полный адрес склада. Адрес должен быть уникальным.
                        </div>
                    </div>

                    <!-- Кнопки формы -->
                    <div class="d-flex justify-content-between">
                        <a href="/admin/warehouses" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Отмена
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i>
                            <span th:if="${warehouse.id != null}">Сохранить изменения</span>
                            <span th:unless="${warehouse.id != null}">Добавить склад</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Важное примечание -->
        <div class="alert alert-info mt-4">
            <div class="d-flex">
                <i class="bi bi-info-circle-fill me-2"></i>
                <div>
                    <strong>Важно!</strong>
                    <ul class="mb-0 mt-1">
                        <li>Адрес склада должен быть уникальным в системе</li>
                        <li>Нельзя создать два склада с одинаковым адресом</li>
                        <li>При редактировании убедитесь, что новый адрес не совпадает с существующим</li>
                        <li>Изменение адреса склада не влияет на остатки товаров на нем</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<footer class="footer">
    <div class="container text-center">
        <p class="mb-0">© 2026 Печенька.ru - Система управления</p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/app.js}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        const requiredFields = form.querySelectorAll('[required]');

        // Удаляем автоматические сообщения браузера
        form.setAttribute('novalidate', true);

        form.addEventListener('submit', function(e) {
            let isValid = true;

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');

                    // Создаем или находим сообщение об ошибке
                    let errorDiv = field.parentElement.querySelector('.invalid-feedback');
                    if (!errorDiv) {
                        errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback';
                        field.parentElement.appendChild(errorDiv);
                    }

                    errorDiv.textContent = 'Пожалуйста, укажите адрес склада';
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');

                    // Очищаем сообщение об ошибке
                    const errorDiv = field.parentElement.querySelector('.invalid-feedback');
                    if (errorDiv && !errorDiv.hasAttribute('th:if')) {
                        errorDiv.textContent = '';
                    }
                }
            });

            if (!isValid) {
                e.preventDefault();

                // Прокручиваем к первой ошибке
                const firstInvalid = form.querySelector('.is-invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });

        requiredFields.forEach(field => {
            field.addEventListener('input', function() {
                if (this.value.trim()) {
                    this.classList.remove('is-invalid');

                    // Очищаем сообщение об ошибке, если оно не от Thymeleaf
                    const errorDiv = this.parentElement.querySelector('.invalid-feedback');
                    if (errorDiv && !errorDiv.hasAttribute('th:if')) {
                        errorDiv.textContent = '';
                    }
                }
            });

            // Очистка при фокусе
            field.addEventListener('focus', function() {
                this.classList.remove('is-invalid');

                // Очищаем только JS-сообщения об ошибках
                const errorDiv = this.parentElement.querySelector('.invalid-feedback');
                if (errorDiv && !errorDiv.hasAttribute('th:if')) {
                    errorDiv.textContent = '';
                }
            });
        });

        // Автоматически скрываем алерты через 5 секунд
        setTimeout(() => {
            document.querySelectorAll('.alert:not(.alert-danger)').forEach(alert => {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            });
        }, 5000);
    });
</script>
</body>
</html>